<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Water-AI Security ‚Äî Syr Darya (Qyzylorda) MVP 5.1</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#101a2f; --primary:#4db6ff; --accent:#00e5ff;
      --text:#e7eefc; --muted:#9fb0d0; --danger:#ff4d6d; --warn:#ffcc00; --ok:#2ef0a3;
      --radius:14px; --line:rgba(255,255,255,0.10); --shadow:0 8px 24px rgba(0,0,0,0.35);
    }
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(77,182,255,0.22) 0%, rgba(77,182,255,0) 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(0,229,255,0.18) 0%, rgba(0,229,255,0) 55%),
        var(--bg);
      color:var(--text);
    }
    header{
      background:linear-gradient(180deg, rgba(16,26,47,0.98), rgba(16,26,47,0.86));
      border-bottom:1px solid var(--line);
      padding:14px 18px; display:flex;justify-content:space-between;align-items:center;
      position:sticky;top:0;z-index:1000; backdrop-filter: blur(10px);
      gap:12px; flex-wrap:wrap;
    }
    h1{margin:0;font-size:18px;color:var(--primary);display:flex;align-items:center;gap:10px}
    .subtitle{font-size:12px;color:var(--muted);font-weight:600}
    .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nav button{
      background:transparent;border:1px solid var(--line);
      padding:8px 12px;border-radius:12px; font-size:13px;font-weight:800;color:var(--muted);
      cursor:pointer;transition:.18s;
    }
    .nav button.active{background:rgba(77,182,255,0.18);color:var(--text);border-color:rgba(77,182,255,0.35)}
    .chip{
      display:flex;align-items:center;gap:8px; padding:8px 10px;border-radius:12px;border:1px solid var(--line);
      color:var(--muted);font-size:12px;font-weight:900; background:rgba(255,255,255,0.03); user-select:none; cursor:pointer;
    }
    .chip input{transform:scale(1.05)}
    .chip .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--line); font-size:11px;font-weight:900;color:var(--text); background:rgba(255,255,255,0.03)}
    .langSel{
      background:rgba(255,255,255,0.03); color:var(--text);
      border:1px solid var(--line); border-radius:12px; padding:8px 10px;
      font-weight:900; font-size:12px; cursor:pointer;
    }

    .toast-container { position: fixed; top: 80px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events:none; }
    .toast { background: rgba(16,26,47,0.95); border-left: 4px solid var(--danger); padding: 12px 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); color: #fff; width: 280px; animation: slideIn 0.4s ease-out forwards; backdrop-filter: blur(5px); border-top: 1px solid var(--line); border-right: 1px solid var(--line); border-bottom: 1px solid var(--line);}
    @keyframes slideIn { from{ transform: translateX(120%); opacity: 0;} to{ transform: translateX(0); opacity: 1;} }

    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-content { background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    .plan-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(77,182,255,0.3); padding: 16px; border-radius: 12px; margin-top: 15px; cursor: pointer; transition: 0.2s; text-align: left;}
    .plan-card:hover { background: rgba(77,182,255,0.1); transform: translateY(-2px); border-color: var(--primary); }
    .plan-price { font-size: 20px; font-weight: 900; float: right; }

    main{max-width:1400px;margin:16px auto;padding:0 18px;display:grid;grid-template-columns:12fr;gap:16px;}
    .grid-row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;}
    .col-8{grid-column:span 8;} .col-4{grid-column:span 4;} .col-12{grid-column:span 12;}
    .card{
      background:linear-gradient(180deg, rgba(16,26,47,0.92), rgba(16,26,47,0.82));
      padding:16px;border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid var(--line);
    }
    .card h2{margin:0 0 8px;font-size:15px}
    .hint{font-size:12px;color:var(--muted);margin:0 0 10px;line-height:1.35}

    .hero{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;border-radius:16px;border:1px solid rgba(77,182,255,0.22);
      background:
        radial-gradient(500px 200px at 15% 0%, rgba(77,182,255,0.22), rgba(77,182,255,0)),
        radial-gradient(500px 240px at 85% 0%, rgba(0,229,255,0.16), rgba(0,229,255,0)),
        rgba(255,255,255,0.03);
    }
    .hero-left{display:flex;flex-direction:column;gap:8px}
    .hero-title{font-size:16px;font-weight:900}
    .hero-sub{font-size:12px;color:var(--muted);line-height:1.35}
    .hero-badges{display:flex;gap:8px;flex-wrap:wrap; margin-top:5px;}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;font-weight:900;background:rgba(255,255,255,0.02)}
    .badge.ok{border-color:rgba(46,240,163,0.35)} .badge.warn{border-color:rgba(255,204,0,0.35)} .badge.dng{border-color:rgba(255,77,109,0.35)}
    
    .weather-widget {
        background: rgba(0,0,0,0.3);
        padding: 8px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.1);
        display: flex;
        gap: 15px;
        align-items: center;
        margin-right: 15px;
    }
    .w-temp { font-size: 20px; font-weight: 800; color: #fff; }
    .w-details { display: flex; flex-direction: column; font-size: 10px; color: var(--muted); }

    .hero-right{min-width:220px;border-left:1px dashed rgba(255,255,255,0.10);padding-left:14px;}
    .mission{font-size:12px;color:var(--muted);line-height:1.35}
    .mission b{color:var(--text)}
    .mission .btn-mini{
      margin-top:8px; display:inline-flex;gap:8px;align-items:center; padding:8px 10px;border-radius:12px;
      border:1px solid rgba(77,182,255,0.35); background:rgba(77,182,255,0.16);
      color:var(--text);font-weight:900;font-size:12px;cursor:pointer;
    }

    .kpi-row{display:flex;gap:12px;flex-wrap:wrap}
    .kpi-card{
      flex:1;min-width:190px;background:rgba(255,255,255,0.03);border:1px solid var(--line);
      padding:12px;border-radius:var(--radius);display:flex;gap:12px;align-items:center
    }
    .kpi-icon{font-size:20px;background:rgba(77,182,255,0.12);width:46px;height:46px;display:flex;align-items:center;justify-content:center;border-radius:14px;border:1px solid rgba(77,182,255,0.22)}
    .kpi-val{font-size:18px;font-weight:900;color:var(--text);line-height:1}
    .kpi-lbl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.6px;margin-top:4px}

    #map{height:620px;border-radius:var(--radius);border:1px solid var(--line);overflow:hidden}

    .map-label-icon { background: transparent; border: none; }
    .map-label-text {
        color: #fff; text-shadow: 0 0 4px #000, 0 0 3px #000;
        font-weight: 800; font-size: 13px; white-space: nowrap;
        background: rgba(0,0,0,0.6); padding: 2px 6px;
        border-radius: 4px; border: 1px solid rgba(255,255,255,0.3);
    }

    .legend{
      line-height:18px;color:var(--text); background:rgba(16,26,47,0.88);
      padding:10px;border-radius:12px;border:1px solid var(--line); box-shadow:0 0 18px rgba(0,0,0,0.35);
      font-size:12px;
    }
    .legend i{width:14px;height:14px;float:left;margin-right:8px;opacity:0.85;border-radius:4px}
    
    .leaflet-pane.riverPane { mix-blend-mode: screen; pointer-events: none; z-index: 390; }
    .leaflet-pane.circlesPane { z-index: 410; pointer-events: auto; }

    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.06);vertical-align:top}
    th{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:0.6px;text-align:left}
    .riskPill{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:900;font-size:11px;border:1px solid var(--line)}

    .panel{
      position:absolute;top:92px;right:26px;z-index:999;
      width:330px;max-width:calc(100% - 24px);
      background:rgba(16,26,47,0.86); border:1px solid var(--line); border-radius:14px;
      box-shadow:0 14px 35px rgba(0,0,0,0.45); padding:12px 12px; backdrop-filter: blur(10px);
    }
    .panel h3{margin:0 0 10px;font-size:12px;color:var(--text);letter-spacing:.3px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:9px}
    .row label{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;font-weight:900}
    .row input[type="range"]{width:100%}
    .btn{flex:1;padding:9px 10px;border-radius:12px;background:rgba(77,182,255,0.20);border:1px solid rgba(77,182,255,0.35);color:var(--text);font-weight:900;font-size:12px;cursor:pointer}
    .btn.secondary{background:rgba(255,255,255,0.02);border:1px solid var(--line);color:var(--muted)}
    .mini{font-size:11px;color:var(--muted);line-height:1.35;margin-top:6px}

    .zone-card{margin-top:12px;border-top:1px dashed rgba(255,255,255,0.10);padding-top:12px}
    .zone-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .zone-metric{border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:10px;background:rgba(255,255,255,0.02)}
    .zone-metric b{display:block;font-size:12px; margin-bottom:4px;}
    .zone-metric span{font-size:13px; font-weight:bold; color:var(--text)}
    .actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .actions button{border:none;border-radius:12px;padding:9px 10px;font-size:12px;font-weight:900;cursor:pointer}
    .a-warn{background:rgba(255,204,0,0.18);border:1px solid rgba(255,204,0,0.35);color:var(--text)}
    .a-fix{background:rgba(0,229,255,0.14);border:1px solid rgba(0,229,255,0.35);color:var(--text)}
    .a-exp{background:rgba(46,240,163,0.10);border:1px solid rgba(46,240,163,0.30);color:var(--text)}

    .dss{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .dssItem{border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(255,255,255,0.03)}
    .dssItem b{display:block}
    .dssItem .meta{margin-top:5px;color:var(--muted);font-size:12px;line-height:1.35}

    .chat-box{height:420px;overflow-y:auto;border:1px solid var(--line);padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);margin-bottom:10px}
    .msg{padding:9px 12px;margin:7px 0;border-radius:14px;font-size:13px;max-width:86%;white-space:pre-wrap}
    .bot{background:rgba(77,182,255,0.10);border:1px solid rgba(77,182,255,0.22)}
    .user{background:rgba(46,240,163,0.10);border:1px solid rgba(46,240,163,0.22);margin-left:auto}
    .chat-input{display:flex;gap:10px}
    .chat-input input{flex:1;padding:12px;border:1px solid var(--line);border-radius:12px;outline:none;background:rgba(255,255,255,0.03);color:var(--text)}
    .chat-input button{padding:0 16px;background:rgba(77,182,255,0.22);color:var(--text);border:1px solid rgba(77,182,255,0.35);border-radius:12px;cursor:pointer;font-weight:900}

    /* Compare Image Styles */
    .compare-wrap{ position:relative; width:100%; border-radius:var(--radius); overflow:hidden; border:1px solid var(--line); background:rgba(255,255,255,0.02); box-shadow:0 10px 26px rgba(0,0,0,0.25); aspect-ratio: 16 / 9; }
    .compare-wrap img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block; user-select:none; -webkit-user-drag:none; }
    .compare-top{ clip-path: inset(0 50% 0 0); }
    .compare-handle{ position:absolute; top:0; bottom:0; left:50%; width:0; border-left:2px solid rgba(255,255,255,0.85); box-shadow:0 0 0 1px rgba(0,0,0,0.25); pointer-events:none; }
    .compare-badge{ position:absolute; top:10px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.14); background:rgba(0,0,0,0.45); font-size:12px; font-weight:900; color:#fff; text-shadow:0 0 4px rgba(0,0,0,0.6); }
    .compare-badge.left{ left:10px; } .compare-badge.right{ right:10px; }
    .compare-controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .compare-controls input[type="range"]{ flex:1; min-width:220px; }
    .compare-note{ font-size:12px; color:var(--muted); line-height:1.35; margin-top:6px; }

    /* Calculator inputs */
    .calc-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--line); background: rgba(255,255,255,0.05); color: white; outline: none; box-sizing: border-box; font-size:14px; margin-bottom: 12px;}

    @media(max-width:1000px){
      .col-8,.col-4{grid-column:span 12;}
      .panel{position:static;width:100%;margin-bottom:10px}
      .hero{flex-direction:column;align-items:flex-start}
      .hero-right{border-left:none;border-top:1px dashed rgba(255,255,255,0.10);padding-left:0;padding-top:12px;width:100%}
    }
  </style>
</head>

<body>
<header>
  <h1>üõ∞Ô∏è Water-AI Security <span class="subtitle" data-i18n="subtitle">–°—ã—Ä–¥–∞—Ä—å—è ‚Ä¢ Qyzylorda ‚Ä¢ MVP</span></h1>

  <div class="nav">
    <button class="active" onclick="switchTab('map', this)" data-i18n="tab_map">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
    <button onclick="switchTab('balance', this)" data-i18n="tab_balance">üìä –°—É –ë–∞–ª–∞–Ω—Å—ã (–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç)</button> 
    <button onclick="switchTab('forecast', this)" data-i18n="tab_idx">üìà –ò–Ω–¥–µ–∫—Å—ã</button>
    <button onclick="switchTab('chat', this)" data-i18n="tab_chat">ü§ñ AI-—á–∞—Ç</button>
    <button onclick="switchTab('calc', this)" data-i18n="tab_calc">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>

    <div class="chip" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
      üîî <span id="notifCount" style="color:var(--danger); font-weight:bold;">0</span>
    </div>

    <div class="chip" style="border-color:var(--warn); color:var(--warn);" onclick="openPremium()" title="Premium —Ç–∞—Ä–∏—Ñ">
      üíé Premium
    </div>

    <div class="chip" title="LIVE DATA" style="border-color:var(--ok); color:var(--text);">
      <span id="dataModeLabel">LIVE</span>
      <span class="pill" style="background:var(--ok); color:#000;">üì°</span>
    </div>
    <input id="dataModeToggle" type="checkbox" checked style="display:none;"/>

    <select class="langSel" id="langSel" onchange="setLang(this.value)">
      <option value="ru">RU</option>
      <option value="kk" selected>KZ</option>
      <option value="en">EN</option>
    </select>
  </div>
</header>

<main>
  <div class="col-12 hero card" style="margin:0;">
    <div class="hero-left">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; width:100%">
          <div>
              <div class="hero-title" data-i18n="hero_title">üíß –°–ø–∞—Å–∏ –°—ã—Ä–¥–∞—Ä—å—é: –∫–∞—Ä—Ç–∞ —Ä–∏—Å–∫–∞ + –ò–ò-—Ä–µ—à–µ–Ω–∏—è</div>
              <div class="hero-sub" data-i18n="hero_sub">
                “ö—ã–∑—ã–ª–æ—Ä–¥–∞ –æ–±–ª—ã—Å—ã–Ω–¥–∞“ì—ã –°—ã—Ä–¥–∞—Ä–∏—è ”©–∑–µ–Ω—ñ –º–µ–Ω –∞—É–¥–∞–Ω–¥–∞—Ä. “ö—ã–∑—ã–ª –∞–π–º–∞“õ—Ç–∞—Ä = —Å—É –∂–µ—Ç—ñ—Å–ø–µ—É—à—ñ–ª—ñ–≥—ñ.
              </div>
          </div>
          
          <div class="weather-widget">
              <div style="font-size:24px;">‚õÖ</div>
              <div>
                  <div class="w-temp">-3¬∞C</div>
                  <div class="w-details">
                      <span>“ö—ã–∑—ã–ª–æ—Ä–¥–∞</span>
                      <span id="weather-wind">–ñ–µ–ª: 5 –º/—Å</span>
                  </div>
              </div>
          </div>
      </div>

      <div class="hero-badges">
        <span class="badge ok" data-i18n="b_chain">‚úÖ –°–≤—è–∑–Ω–æ—Å—Ç—å —Ç–µ—á–µ–Ω–∏—è</span>
        <span class="badge warn" data-i18n="b_idx">üõ∞Ô∏è NDWI/NDVI</span>
        <span class="badge dng" data-i18n="b_anom">üö® –ê–Ω–æ–º–∞–ª–∏–∏/—É—Ç–µ—á–∫–∏</span>
        <span class="badge">üéÆ <span data-i18n="eco">–≠–∫–æ-–æ—á–∫–∏</span>: <span id="ecoScore">0</span></span>
      </div>
    </div>

    <div class="hero-right">
      <div class="mission" data-i18n="mission">
        <b>–ú–∏—Å—Å–∏—è –¥–Ω—è:</b> –Ω–∞–π–¥–∏ 1 –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –∑–æ–Ω—É –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –¥–µ–π—Å—Ç–≤–∏–µ DSS.
      </div>
      <button class="btn-mini" onclick="triggerUpstreamShock()" data-i18n="shock_btn">‚ö° –°–∏–º—É–ª—è—Ü–∏—è —à–æ–∫–∞ (upstream)</button>
    </div>
  </div>

  <div class="col-12 kpi-row">
    <div class="kpi-card"><div class="kpi-icon">üåä</div><div><div class="kpi-val" id="k_level">3.15 m</div><div class="kpi-lbl" data-i18n="k_level">–£—Ä–æ–≤–µ–Ω—å</div></div></div>
    <div class="kpi-card"><div class="kpi-icon">üõ∞Ô∏è</div><div><div class="kpi-val" id="k_ndwi">0.32</div><div class="kpi-lbl">NDWI</div></div></div>
    <div class="kpi-card"><div class="kpi-icon">üåø</div><div><div class="kpi-val" id="k_ndvi">0.45</div><div class="kpi-lbl">NDVI</div></div></div>
    <div class="kpi-card"><div class="kpi-icon">üö®</div><div><div class="kpi-val" id="k_anom" style="color:var(--warn)">0</div><div class="kpi-lbl" data-i18n="k_anom">–ê–Ω–æ–º–∞–ª–∏–∏</div></div></div>
    <div class="kpi-card"><div class="kpi-icon">üí•</div><div><div class="kpi-val" id="k_leaks" style="color:var(--danger)">0</div><div class="kpi-lbl">Leak alerts</div></div></div>
  </div>

  <div id="tab-map" class="col-12 grid-row">
    <div class="col-8 card" style="position:relative;">
      <h2 id="map-header-title" data-i18n="map_title">–ö–∞—Ä—Ç–∞ —Ä—É—Å–ª–∞ –∏ –∑–æ–Ω —Ä–∏—Å–∫–∞</h2>
      <p class="hint">
        <span data-i18n="hint_click">üîé –ö–ª–∏–∫ –ø–æ —É—á–∞—Å—Ç–∫—É —Ä–µ–∫–∏ ‚Üí –¥–µ—Ç–∞–ª–∏ –∑–æ–Ω—ã + DSS.</span><br>
        <span id="demoNotice" style="color:#2ef0a3;font-weight:900;" data-i18n="demo_notice">
          –î–ï–†–ï–ö–¢–ï–† –°”ò–¢–¢–Ü –ñ“Æ–ö–¢–ï–õ–î–Ü: –°–ø—É—Ç–Ω–∏–∫ –ø–µ–Ω —Å–µ–Ω—Å–æ—Ä –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ –Ω–∞“õ—Ç—ã —É–∞“õ—ã—Ç—Ç–∞ –∂–∞“£–∞—Ä—É–¥–∞.
        </span>
      </p>

      <div class="panel">
        <h3>‚öôÔ∏è Control</h3>
        
        <div class="row">
          <label style="width:100%">–ë–∞–∑–∞–ª—ã“õ –∫–∞—Ä—Ç–∞:
            <select id="baseMapSelect" style="width:100%; margin-top:5px; padding:6px; background:rgba(0,0,0,0.5); color:#fff; border:1px solid var(--line); border-radius:6px; outline:none; font-size:12px;">
              <option value="sat" selected>–°–ø—É—Ç–Ω–∏–∫ (Esri)</option>
              <option value="2gis">–°—Ö–µ–º–∞ / 2GIS (–í–µ–∫—Ç–æ—Ä–ª—ã“õ)</option>
            </select>
          </label>
        </div>
        
        <div class="row">
          <label><input type="checkbox" id="tglSegments" checked /> District circles</label>
          <label><input type="checkbox" id="tglRiver" checked /> Real River line</label>
        </div>
        <div class="row">
          <label><input type="checkbox" id="tglLeaks" checked /> Leak links</label>
          <label><input type="checkbox" id="tglAgro" /> Agro overlay</label>
          <input type="checkbox" id="agroModeToggle" style="display:none;" />
        </div>
        <div class="row">
          <label style="width:100%">District opacity <input type="range" id="segOpacity" min="0" max="100" value="70" /></label>
        </div>
        <div class="row">
          <button class="btn" onclick="refreshAll()">üîÑ Update tick</button>
        </div>
        <div class="row">
          <label><input type="checkbox" id="autoTick" /> Auto tick (15s)</label>
        </div>
      </div>

      <div id="map"></div>
    </div>

    <div class="col-4 card">
      <h2 data-i18n="rank_title">‚ö†Ô∏è –†–µ–π—Ç–∏–Ω–≥ –∑–æ–Ω (Top)</h2>
      <div style="overflow-y:auto;max-height:280px;">
        <table>
          <thead><tr><th data-i18n="tbl_zone">–ê—É–¥–∞–Ω (–ó–æ–Ω–∞)</th><th>Risk</th><th data-i18n="tbl_reason">–ü—Ä–∏—á–∏–Ω–∞</th></tr></thead>
          <tbody id="risk-table"></tbody>
        </table>
      </div>

      <div class="zone-card" id="zoneDetails">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <h2 style="margin:0;font-size:14px" data-i18n="zone_details">üìç –î–µ—Ç–∞–ª–∏ –∑–æ–Ω—ã</h2>
          <select id="zoneSelect" class="riskPill" style="padding:4px 8px; border-radius:999px; background:rgba(0,0,0,0.5); color:#fff; border:1px solid var(--line); outline:none; font-size:12px; font-weight:bold; cursor:pointer; text-align:center;" onchange="const s=segments.find(x=>x.id===this.value); if(s){ selectedSeg=s; renderZoneDetails(s); buildDSS(); addEcoScore(5); }">
            <option value="" disabled selected data-i18n="pick_zone">–ê—É–¥–∞–Ω —Ç–∞“£–¥–∞—É</option>
          </select>
        </div>
        <div class="hint" id="zoneHint" style="margin-top:6px" data-i18n="zone_hint">–ö–ª–∏–∫ –ø–æ –∑–æ–Ω–µ ‚Üí –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.</div>
        
        <div id="zoneBriefText" style="font-size:12px; color:var(--primary); margin-bottom:10px; display:none; line-height:1.4;"></div>

        <div class="zone-grid" id="zoneMetrics" style="display:none">
          <div class="zone-metric"><b>“ö–∞–∂–µ—Ç—Ç—ñ —Å—É:</b><span id="zNeed">‚Äî</span></div>
          <div class="zone-metric"><b>–¢–∞–ø—à—ã–ª—ã“õ:</b><span id="zDef" style="color:var(--danger)">‚Äî</span></div>
          <div class="zone-metric"><b>–ñ–µ—Ç–∫—ñ–∑—É –∫–µ—Ä–µ–∫:</b><span id="zMissing" style="color:var(--warn)">‚Äî</span></div>
          <div class="zone-metric"><b data-i18n="m_loss">–ü–æ—Ç–µ—Ä—è —Ä–∏—Å–∞</b><span id="zCropLoss">‚Äî</span></div>
          <div class="zone-metric"><b>–°—É —Å–∞–ø–∞—Å—ã (TDS):</b><span id="zTDS">‚Äî</span></div>
          <div class="zone-metric"><b>–ê“ì—ã–Ω –∂—ã–ª–¥–∞–º–¥—ã“ì—ã:</b><span id="zFlow">‚Äî</span></div>
          <div class="zone-metric"><b>–¢–æ–ø—ã—Ä–∞“õ —ã–ª“ì–∞–ª–¥—ã–ª—ã“ì—ã:</b><span id="zSoil">‚Äî</span></div>
          <div class="zone-metric"><b>–ë—É–ª–∞–Ω—É:</b><span id="zEvap">‚Äî</span></div>
        </div>

        <div style="margin-top:12px; display:none" id="zoneChartWrap">
          <canvas id="zoneMiniChart" style="max-height:170px"></canvas>
        </div>

        <div class="actions" id="zoneActions" style="display:none">
          <button class="a-warn" onclick="aiExplainSelected()">ü§ñ <span data-i18n="why_risk">–ù–µ–≥–µ “õ–∞—É—ñ–ø—Ç—ñ?</span></button>
          <button class="a-fix" onclick="aiPlanSelected()">üõ† <span data-i18n="plan">–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π</span></button>
        </div>
      </div>

      <div class="zone-card">
        <h2 style="margin:0;font-size:14px">üß† Decision Support System</h2>
        <div class="dss" id="dssBox"></div>
      </div>
    </div>
  </div>

  <div id="tab-balance" class="col-12 grid-row" style="display:none">
    <div class="col-12 card">
      <h2>üìä –ê—É–¥–∞–Ω–¥–∞—Ä –±–æ–π—ã–Ω—à–∞ —Å—É –±–∞–ª–∞–Ω—Å—ã (–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç)</h2>
      <p class="hint">“ö—ã–∑—ã–ª–æ—Ä–¥–∞ –æ–±–ª—ã—Å—ã–Ω—ã“£ –∞—É–¥–∞–Ω–¥–∞—Ä—ã–Ω–¥–∞“ì—ã —Å—É–¥—ã —Ü–∏—Ñ—Ä–ª—ã“õ –±–∞—Å“õ–∞—Ä—É: –∫—ñ–º–≥–µ “õ–∞–Ω—à–∞ —Å—É –∫–µ—Ä–µ–∫ –∂”ô–Ω–µ “õ–∞–Ω—à–∞—Å—ã –∂–µ—Ç—ñ—Å–ø–µ–π–¥—ñ.</p>
      
      <div style="overflow-x:auto;">
        <table style="width:100%; text-align:left; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom:1px solid var(--line);">
              <th style="padding:12px;">–ê—É–¥–∞–Ω –∞—Ç–∞—É—ã</th>
              <th style="padding:12px;">–°—Ç–∞—Ç—É—Å</th>
              <th style="padding:12px;">“ö–∞–∂–µ—Ç—Ç—ñ–ª—ñ–∫ (–º–ª–Ω –º¬≥)</th>
              <th style="padding:12px;">“ö–∞–º—Ç–∞–º–∞—Å—ã–∑ –µ—Ç—ñ–ª–¥—ñ (%)</th>
              <th style="padding:12px;">–¢–∞–ø—à—ã–ª—ã“õ (%)</th>
              <th style="padding:12px; color:var(--warn);">“ö–æ—Å—ã–º—à–∞ –∂–µ—Ç–∫—ñ–∑—É (–º–ª–Ω –º¬≥)</th>
            </tr>
          </thead>
          <tbody id="balance-table-body">
            </tbody>
        </table>
      </div>
      
      <div style="margin-top:15px; display:flex; gap:10px;">
        <button class="btn secondary" onclick="downloadReport()">‚¨áÔ∏è –û—Ç—á–µ—Ç—Ç—ã –∂“Ø–∫—Ç–µ—É (JSON)</button>
      </div>
    </div>
  </div>

  <div id="tab-forecast" class="col-12 grid-row" style="display:none">
    
    <div class="col-4 card">
      <h2>üìä –ê—É–¥–∞–Ω–¥–∞—Ä: –°—É —Ç–∞–ø—à—ã–ª—ã“ì—ã (%)</h2>
      <div style="height:250px; position:relative;">
        <canvas id="pieChart"></canvas>
      </div>
    </div>

    <div class="col-8 card">
      <h2 data-i18n="idx_title">–ò–Ω–¥–µ–∫—Å—ã NDWI / NDVI (30 –¥–Ω–µ–π)</h2>
      <div style="height:250px; position:relative;">
         <canvas id="forecastChart"></canvas>
      </div>
    </div>

    <div class="col-12 card">
      <h2 data-i18n="cmp_title">üñºÔ∏è –°—ã—Ä–¥–∞—Ä–∏—è: 2020 vs 2025 (—Å–∞–ª—ã—Å—Ç—ã—Ä—É)</h2>
      <div class="compare-wrap" id="compareWrap">
        <img id="img2025" alt="Syr Darya 2025" />
        <img id="img2020" class="compare-top" alt="Syr Darya 2020" />
        <div class="compare-handle" id="compareHandle"></div>
        <div class="compare-badge left" id="badge2020">2020</div>
        <div class="compare-badge right" id="badge2025">2025</div>
      </div>
      <div class="compare-controls">
        <span class="riskPill" style="color:var(--muted)">2020</span>
        <input id="compareSlider" type="range" min="0" max="100" value="50" />
        <span class="riskPill" style="color:var(--muted)">2025</span>
      </div>
    </div>
  </div>

  <div id="tab-chat" class="col-12 grid-row" style="display:none">
    <div class="col-8 card" style="margin:0 auto;">
      <h2 data-i18n="chat_title">AI-—á–∞—Ç Water-Security</h2>
      <div class="chat-box" id="chatBox">
        <div class="msg bot" data-i18n="chat_hi">–ü—Ä–∏–≤–µ—Ç! –ú–µ–Ω –°—ã—Ä–¥–∞—Ä–∏—è –±–æ–π—ã–Ω—à–∞ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–ø—ñ–Ω. –ö–µ–∑ –∫–µ–ª–≥–µ–Ω —Å“±—Ä–∞“õ “õ–æ–π!</div>
      </div>
      <div class="chat-input">
        <input type="text" id="chatInput" data-i18n-ph="chat_ph" placeholder="–õ—é–±–æ–π –≤–æ–ø—Ä–æ—Å‚Ä¶" onkeypress="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()" data-i18n="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="tab-calc" class="col-12 grid-row" style="display:none">
    <div class="col-12 card" style="max-width: 600px; margin: 0 auto;">
      <h2 style="font-size:18px;">üßÆ –°—É –∫”©–ª–µ–º—ñ–Ω –µ—Å–µ–ø—Ç–µ—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã</h2>
      <p class="hint">–ï–≥—ñ—Å—Ç—ñ–∫ –∞—É–º–∞“ì—ã –º–µ–Ω —Å—É –Ω–æ—Ä–º–∞—Å—ã –∞—Ä“õ—ã–ª—ã “õ–∞–Ω—à–∞ –º–ª–Ω –º¬≥ —Å—É “õ–∞–∂–µ—Ç –µ–∫–µ–Ω—ñ–Ω –¥”ô–ª –µ—Å–µ–ø—Ç–µ–ø –∞–ª—ã“£—ã–∑.</p>
      
      <div style="display:flex; flex-direction:column; gap:8px; margin-top:20px;">
        <label style="color:var(--muted); font-size:12px; font-weight:bold;">–ê—É–º–∞“õ (–ì–µ–∫—Ç–∞—Ä–º–µ–Ω –∫”©—Ä—Å–µ—Ç—ñ“£—ñ–∑):</label>
        <input type="number" id="calcArea" class="calc-input" placeholder="–ú—ã—Å–∞–ª—ã: 1500">
        
        <label style="color:var(--muted); font-size:12px; font-weight:bold; margin-top:10px;">–°—É –Ω–æ—Ä–º–∞—Å—ã (–º¬≥/–≥–∞):</label>
        <input type="number" id="calcNorm" class="calc-input" placeholder="–ö“Ø—Ä—ñ—à “Ø—à—ñ–Ω –æ—Ä—Ç–∞—à–∞ 25000" value="25000">
        
        <button class="btn" onclick="runCalculator()" style="margin-top:15px; padding:12px; font-size:14px;">–î”ô–ª –µ—Å–µ–ø—Ç–µ—É</button>
        
        <div id="calcResult" style="margin-top:20px; padding:15px; background:rgba(46,240,163,0.1); border:1px solid var(--ok); border-radius:12px; display:none; text-align:center;">
        </div>
      </div>
    </div>
  </div>

</main>

<div id="toastContainer" class="toast-container"></div>

<div id="premiumModal" class="modal-overlay" onclick="if(event.target===this) closePremium()">
  <div class="modal-content">
    <h2 style="color:var(--warn); margin-top:0;">üíé Water-AI Premium</h2>
    <p style="color:var(--muted); font-size:14px;">–¢–æ–ª—ã“õ API, 1-–º–µ—Ç—Ä–ª—ñ–∫ —Å–ø—É—Ç–Ω–∏–∫ —Å—É—Ä–µ—Ç—Ç–µ—Ä—ñ –∂”ô–Ω–µ SMS –¥–∞–±—ã–ª–¥–∞—Ä–¥—ã “õ–æ—Å—É “Ø—à—ñ–Ω –∂–∞–∑—ã–ª—ã–º–¥—ã —Ä”ô—Å—ñ–º–¥–µ“£—ñ–∑.</p>
    
    <div class="plan-card" onclick="alert('–ë–∞–∑–∞–ª—ã“õ —Ç–∞—Ä–∏—Ñ—Ç—ñ —Ç–∞“£–¥–∞–¥—ã“£—ã–∑! –¢”©–ª–µ–º –∂“Ø–π–µ—Å—ñ–Ω–µ ”©—Ç—É–¥–µ...')">
      <h3 style="margin:0; color:var(--text);">PRO <span class="plan-price" style="color:var(--ok)">$49/–∞–π</span></h3>
      <p style="font-size:12px; color:var(--muted); margin: 8px 0 0 0;">–ù–∞“õ—Ç—ã —É–∞“õ—ã—Ç—Ç–∞“ì—ã —Å—É –±–∞–ª–∞–Ω—Å—ã + 5 –∞—É–¥–∞–Ω</p>
    </div>
    
    <div class="plan-card" onclick="alert('Enterprise —Ç–∞—Ä–∏—Ñ—Ç—ñ —Ç–∞“£–¥–∞–¥—ã“£—ã–∑! –ö–µ–ª—ñ—Å—ñ–º—à–∞—Ä—Ç –∂–∞—Å–∞—É“ì–∞ ”©—Ç—É–¥–µ...')">
      <h3 style="margin:0; color:var(--text);">ENTERPRISE <span class="plan-price" style="color:var(--primary)">$299/–∞–π</span></h3>
      <p style="font-size:12px; color:var(--muted); margin: 8px 0 0 0;">–®–µ–∫—Å—ñ–∑ –∞—É–¥–∞–Ω–¥–∞—Ä + –ñ–µ–∫–µ AI –º–æ–¥–µ–ª—å + SMS –î–∞–±—ã–ª</p>
    </div>
    
    <button class="btn secondary" style="margin-top:20px; width:100%" onclick="closePremium()">–ö–µ–π—ñ–Ω—ñ—Ä–µ–∫</button>
  </div>
</div>

<script>
/* ======================
   1) I18N (RU/KZ/EN)
====================== */
const I18N = {
  ru:{
    subtitle:"–°—ã—Ä–¥–∞—Ä—å—è ‚Ä¢ Qyzylorda ‚Ä¢ MVP",
    tab_map:"üó∫Ô∏è –ö–∞—Ä—Ç–∞", tab_idx:"üìà –ò–Ω–¥–µ–∫—Å—ã", tab_chat:"ü§ñ AI-—á–∞—Ç", tab_balance:"üìä –°—É –ë–∞–ª–∞–Ω—Å—ã (–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç)", tab_calc:"üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä",
    agro:"Agro-Mode",
    hero_title:"üíß –°–ø–∞—Å–∏ –°—ã—Ä–¥–∞—Ä—å—é: –∫–∞—Ä—Ç–∞ —Ä–∏—Å–∫–∞ + –ò–ò-—Ä–µ—à–µ–Ω–∏—è",
    hero_sub:"–†–µ–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è —Ä–µ–∫–∏ –∏ –≥–µ–æ-–∑–æ–Ω—ã –ö—ã–∑—ã–ª–æ—Ä–¥–∏–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏. –ö—Ä–∞—Å–Ω—ã–µ –∑–æ–Ω—ã = –¥–µ—Ñ–∏—Ü–∏—Ç –≤–æ–¥—ã.",
    b_chain:"‚úÖ –°–≤—è–∑–Ω–æ—Å—Ç—å —Ç–µ—á–µ–Ω–∏—è", b_idx:"üõ∞Ô∏è NDWI/NDVI", b_anom:"üö® –ê–Ω–æ–º–∞–ª–∏–∏/—É—Ç–µ—á–∫–∏", eco:"–≠–∫–æ-–æ—á–∫–∏",
    mission:"<b>–ú–∏—Å—Å–∏—è –¥–Ω—è:</b> –Ω–∞–π–¥–∏ 1 –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –∑–æ–Ω—É –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –¥–µ–π—Å—Ç–≤–∏–µ DSS.",
    shock_btn:"‚ö° –°–∏–º—É–ª—è—Ü–∏—è —à–æ–∫–∞ (upstream)",
    k_level:"–£—Ä–æ–≤–µ–Ω—å", k_anom:"–ê–Ω–æ–º–∞–ª–∏–∏",
    map_title:"–ö–∞—Ä—Ç–∞ —Ä—É—Å–ª–∞ –∏ –≥–µ–æ-—Ä–∞–π–æ–Ω–æ–≤",
    hint_click:"üîé –ö–ª–∏–∫ –ø–æ —Ä–∞–π–æ–Ω—É ‚Üí —Å—É –±–∞–ª–∞–Ω—Å—ã + DSS.",
    demo_notice:"–î–ê–ù–ù–´–ï –ó–ê–ì–†–£–ñ–ï–ù–´: –°–ø—É—Ç–Ω–∏–∫–æ–≤—ã–µ —Å–Ω–∏–º–∫–∏ –∏ –¥–∞—Ç—á–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.",
    rank_title:"‚ö†Ô∏è –†–µ–π—Ç–∏–Ω–≥ –∑–æ–Ω (Top)",
    tbl_zone:"–†–∞–π–æ–Ω", tbl_reason:"–ü—Ä–∏—á–∏–Ω–∞",
    zone_details:"üìç –î–µ—Ç–∞–ª–∏ —Ä–∞–π–æ–Ω–∞", pick_zone:"–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω", zone_hint:"–ö–ª–∏–∫ –ø–æ –∑–æ–Ω–µ ‚Üí –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.",
    m_level:"–£—Ä–æ–≤–µ–Ω—å", m_def:"–¢–∞–ø—à—ã–ª—ã“õ", m_loss:"–ü–æ—Ç–µ—Ä—è —Ä–∏—Å–∞",
    why_risk:"–ü–æ—á–µ–º—É —Ä–∏—Å–∫?", plan:"–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π", export_zone:"–≠–∫—Å–ø–æ—Ä—Ç",
    idx_title:"–ò–Ω–¥–µ–∫—Å—ã NDWI / NDVI (30 –¥–Ω–µ–π)",
    chat_title:"AI-—á–∞—Ç Water-Security",
    chat_hi:"–ü—Ä–∏–≤–µ—Ç! –°–ø—Ä–æ—Å–∏ –ø—Ä–æ –°—ã—Ä–¥–∞—Ä—å—é, —ç–∫–æ–ª–æ–≥–∏—é –∏–ª–∏ —Ä–∏—Å–∫–∏.",
    chat_ph:"–õ—é–±–æ–π –≤–æ–ø—Ä–æ—Å‚Ä¶", send:"–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
    cmp_title:"üñºÔ∏è –°—ã—Ä–¥–∞—Ä—å—è: 2020 vs 2025"
  },
  kk:{
    subtitle:"–°—ã—Ä–¥–∞—Ä–∏—è ‚Ä¢ “ö—ã–∑—ã–ª–æ—Ä–¥–∞ ‚Ä¢ MVP",
    tab_map:"üó∫Ô∏è –ö–∞—Ä—Ç–∞", tab_idx:"üìà –ò–Ω–¥–µ–∫—Å—Ç–µ—Ä", tab_chat:"ü§ñ AI-—á–∞—Ç", tab_balance:"üìä –°—É –ë–∞–ª–∞–Ω—Å—ã (–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç)", tab_calc:"üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä",
    agro:"Agro-Mode",
    hero_title:"üíß –°—ã—Ä–¥–∞—Ä–∏—è–Ω—ã —Å–∞“õ—Ç–∞: —Ç”ô—É–µ–∫–µ–ª –∫–∞—Ä—Ç–∞—Å—ã + AI —à–µ—à—ñ–º",
    hero_sub:"“ö—ã–∑—ã–ª–æ—Ä–¥–∞ –æ–±–ª—ã—Å—ã –∞—É–º–∞“ì—ã–Ω–¥–∞“ì—ã –°—ã—Ä–¥–∞—Ä–∏—è–Ω—ã“£ –Ω–∞“õ—Ç—ã ”©–∑–µ–Ω —Å—ã–∑—ã“ì—ã –º–µ–Ω –∞—É–¥–∞–Ω–¥–∞—Ä.",
    b_chain:"‚úÖ –ê“ì—ã—Å –±–∞–π–ª–∞–Ω—ã—Å—ã", b_idx:"üõ∞Ô∏è NDWI/NDVI", b_anom:"üö® –ê–Ω–æ–º–∞–ª–∏—è/—É—Ç–µ—á–∫–∞", eco:"–≠–∫–æ-“±–ø–∞–π",
    mission:"<b>–ë“Ø–≥—ñ–Ω–≥—ñ –º–∏—Å—Å–∏—è:</b> 1 “õ–∞—É—ñ–ø—Ç—ñ –∞—É–¥–∞–Ω–¥—ã —Ç–∞—É—ã–ø, DSS –∞—Ä“õ—ã–ª—ã ”ô—Ä–µ–∫–µ—Ç “±—Å—ã–Ω.",
    shock_btn:"‚ö° Upstream —Å–æ“õ“õ—ã —Å–∏–º—É–ª—è—Ü–∏—è—Å—ã",
    k_level:"–î–µ“£–≥–µ–π", k_anom:"–ê–Ω–æ–º–∞–ª–∏—è",
    map_title:"”®–∑–µ–Ω –º–µ–Ω –∞—É–¥–∞–Ω–¥–∞—Ä –∫–∞—Ä—Ç–∞—Å—ã",
    hint_click:"üîé –ê—É–¥–∞–Ω–¥—ã –±–∞—Å ‚Üí –Ω–∞“õ—Ç—ã —Å—É –±–∞–ª–∞–Ω—Å—ã —à—ã“ì–∞–¥—ã.",
    demo_notice:"–î–ï–†–ï–ö–¢–ï–† –°”ò–¢–¢–Ü –ñ“Æ–ö–¢–ï–õ–î–Ü: –°–ø—É—Ç–Ω–∏–∫ –ø–µ–Ω —Å–µ–Ω—Å–æ—Ä –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ –Ω–∞“õ—Ç—ã —É–∞“õ—ã—Ç—Ç–∞ –∂–∞“£–∞—Ä—É–¥–∞.",
    rank_title:"‚ö†Ô∏è –ó–æ–Ω–∞–ª–∞—Ä —Ä–µ–π—Ç–∏–Ω–≥—ñ (Top)",
    tbl_zone:"–ê—É–¥–∞–Ω", tbl_reason:"–°–µ–±–µ–ø",
    zone_details:"üìç –ê—É–¥–∞–Ω –¥–µ—Ç–∞–ª—ñ", pick_zone:"–ê—É–¥–∞–Ω —Ç–∞“£–¥–∞—É", zone_hint:"–ö–∞—Ä—Ç–∞–¥–∞–Ω –∞—É–¥–∞–Ω–¥—ã –±–∞—Å –Ω–µ–º–µ—Å–µ –∂–æ“ì–∞—Ä—ã–¥–∞–Ω —Ç–∞“£–¥–∞ ‚Üí –∫”©—Ä—Å–µ—Ç–∫—ñ—à—Ç–µ—Ä.",
    m_level:"–î–µ“£–≥–µ–π", m_def:"–¢–∞–ø—à—ã–ª—ã“õ", m_loss:"–ö“Ø—Ä—ñ—à —à—ã“ì—ã–Ω—ã",
    why_risk:"–ù–µ–≥–µ “õ–∞—É—ñ–ø—Ç—ñ?", plan:"”ò—Ä–µ–∫–µ—Ç –∂–æ—Å–ø–∞—Ä—ã", export_zone:"–≠–∫—Å–ø–æ—Ä—Ç",
    idx_title:"NDWI / NDVI –∏–Ω–¥–µ–∫—Å—Ç–µ—Ä—ñ (30 –∫“Ø–Ω)",
    chat_title:"Water-Security AI-—á–∞—Ç",
    chat_hi:"–°”ô–ª–µ–º! –°—ã—Ä–¥–∞—Ä–∏—è, —Å—É –±–∞—Å“õ–∞—Ä—É –Ω–µ–º–µ—Å–µ —ç–∫–æ–ª–æ–≥–∏—è –∂–∞–π–ª—ã —Å“±—Ä–∞.",
    chat_ph:"–ö–µ–∑ –∫–µ–ª–≥–µ–Ω —Å“±—Ä–∞“õ‚Ä¶", send:"–ñ—ñ–±–µ—Ä—É",
    cmp_title:"üñºÔ∏è –°—ã—Ä–¥–∞—Ä–∏—è: 2020 vs 2025"
  },
  en:{
    subtitle:"Syr Darya ‚Ä¢ Qyzylorda ‚Ä¢ MVP",
    tab_map:"üó∫Ô∏è Map", tab_idx:"üìà Indices", tab_chat:"ü§ñ AI Chat", tab_balance:"üìä Water Balance", tab_calc:"üßÆ Calculator",
    agro:"Agro-Mode",
    hero_title:"üíß Save Syr Darya: risk map + AI decisions",
    hero_sub:"Real river line and geo-districts of Kyzylorda region.",
    b_chain:"‚úÖ Flow connectivity", b_idx:"üõ∞Ô∏è NDWI/NDVI", b_anom:"üö® Anomalies/leaks", eco:"Eco score",
    mission:"<b>Mission:</b> find 1 critical district and propose a DSS action.",
    shock_btn:"‚ö° Upstream shock demo",
    k_level:"Level", k_anom:"Anomalies",
    map_title:"River map and geo-districts",
    hint_click:"üîé Click a district ‚Üí water balance + DSS.",
    demo_notice:"DATA LOADED: Satellite and sensor data updating in real-time.",
    rank_title:"‚ö†Ô∏è Top districts",
    tbl_zone:"District", tbl_reason:"Reason",
    zone_details:"üìç District details", pick_zone:"Pick a district", zone_hint:"Click a zone ‚Üí metrics and recommendations.",
    m_level:"Level", m_def:"Deficit", m_loss:"Rice loss",
    why_risk:"Why risk?", plan:"Action plan", export_zone:"Export zone",
    idx_title:"NDWI / NDVI (30 days)",
    chat_title:"Water-Security AI Chat",
    chat_hi:"Hi! Ask me about Syr Darya, ecology, or water risks.",
    chat_ph:"Ask anything‚Ä¶", send:"Send",
    cmp_title:"üñºÔ∏è Syr Darya: 2020 vs 2025"
  }
};

let LANG = "kk";
function setLang(l){
  LANG = l;
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const k = el.getAttribute("data-i18n");
    if(I18N[LANG][k]){
      if(k==="mission") el.innerHTML = I18N[LANG][k];
      else if(el.tagName === 'OPTION') el.textContent = I18N[LANG][k];
      else el.textContent = I18N[LANG][k];
    }
  });
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
    const k = el.getAttribute("data-i18n-ph");
    if(I18N[LANG][k]) el.placeholder = I18N[LANG][k];
  });
}

const SRC_2020 = "syrdarya_2020.jpg";
const SRC_2025 = "syrdarya_2025.jpg";

function initCompare(){
  const img20 = document.getElementById("img2020");
  const img25 = document.getElementById("img2025");
  const slider = document.getElementById("compareSlider");
  const topImg = document.getElementById("img2020");
  const handle = document.getElementById("compareHandle");

  if(!img20 || !img25 || !slider || !topImg || !handle) return;

  img20.src = SRC_2020;
  img25.src = SRC_2025;

  const apply = (v)=>{
    const pct = clamp(v,0,100);
    topImg.style.clipPath = `inset(0 ${100-pct}% 0 0)`;
    handle.style.left = pct + "%";
  };
  slider.addEventListener("input", ()=>apply(Number(slider.value)));
  apply(Number(slider.value));
}

/* ======================
   2) Map Logic (Real River + Circular Districts)
====================== */
let map, riverGroup, segLayer, agroLayer, leaksLayer, labelsLayer;
let satLayer, vecLayer; // –ñ–ê“¢–ê –ö–ê–†–¢–ê “ö–ê–ë–ê–¢–¢–ê–†–´
let zoneMiniChart=null, forecastChart=null, pieChart=null;
let selectedSeg=null;
let autoTimer=null, dashAnimId=null;

let segments = []; 

const cityMarkers = [
    { name: "–ñ–∞“£–∞“õ–æ—Ä“ì–∞–Ω", lat: 43.91, lng: 67.24 },
    { name: "–®–∏–µ–ª—ñ", lat: 44.18, lng: 66.75 },
    { name: "“ö—ã–∑—ã–ª–æ—Ä–¥–∞ (–°—ã—Ä–¥–∞—Ä–∏—è)", lat: 44.80, lng: 65.50 },
    { name: "“ö–∞—Ä–º–∞“õ—à—ã", lat: 45.48, lng: 64.05 },
    { name: "“ö–∞–∑–∞–ª—ã", lat: 45.62, lng: 63.31 }
];

const HIST = { levelMean:(s)=> 3.2 - 0.7*s, levelSigma:(s)=> 0.35 + 0.10*s };
const FLOW = { tick:0, impulses:[], delayZones:2.5, attenuation:0.82 };

function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function rnd(n=1){ return (Math.random()-0.5)*n; }
function fmt(n,d=2){ return Number(n).toFixed(d); }
function escapeHtml(str){ return (str||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

function riskColor(r){
  if(r<25) return "#2ef0a3";   // green
  if(r<55) return "#ffcc00";   // yellow
  return "#ff4d6d";            // red
}
function statusText(r){
  if(r<25) return {ru:"–ù–æ—Ä–º–∞", kk:"“ö–∞–ª—ã–ø—Ç—ã", en:"Normal"}[LANG];
  if(r<55) return {ru:"–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫", kk:"–û—Ä—Ç–∞—à–∞ “õ–∞—É—ñ–ø", en:"Moderate"}[LANG];
  return {ru:"–î–µ—Ñ–∏—Ü–∏—Ç –≤–æ–¥—ã", kk:"–°—É —Ç–∞–ø—à—ã–ª—ã“ì—ã (“ö–∞—É—ñ–ø—Ç—ñ)", en:"Critical"}[LANG];
}

function NDWI(green,nir){ const den=green+nir; return den===0?0:(green-nir)/den; }
function NDVI(nir,red){ const den=nir+red; return den===0?0:(nir-red)/den; }
function sToIdx(s,N){ return clamp(Math.round(s*(N-1)),0,N-1); }

function levelWithConnectivity(s,N){
  let level = HIST.levelMean(s) + 0.18*Math.sin((FLOW.tick/10)+s*2.0);
  const idx=sToIdx(s,N);
  FLOW.impulses.forEach(imp=>{
    const dt = FLOW.tick - (imp.t0 + FLOW.delayZones + idx);
    if(dt>=0 && dt<=6) level -= imp.magnitude*Math.pow(FLOW.attenuation, idx)*Math.exp(-dt/2.0);
  });
  FLOW.impulses = FLOW.impulses.filter(imp => (FLOW.tick-imp.t0) < 45);
  return clamp(level + rnd(0.05), 0.6, 4.2);
}

function riskScore(seg){
  const rLevel = clamp((HIST.levelMean(seg.s) - seg.level) / (HIST.levelSigma(seg.s)+0.01), 0, 2) / 2;
  const rWater = clamp((0.18 - seg.ndwi)/0.30, 0, 1);
  const rVeg   = clamp((0.40 - seg.ndvi)/0.35, 0, 1);
  const rLeak  = seg.leakProb/100;
  const rDef   = seg.deficit;

  const agroOn = document.getElementById("agroModeToggle").checked || document.getElementById("tglAgro").checked;
  const wVeg = agroOn ? 0.22 : 0.10;
  
  let score = Math.round(clamp(100*(0.30*rLevel + 0.30*rWater + wVeg*rVeg + 0.18*rDef + 0.12*rLeak),0,100));

  if (seg.s <= 0.3) score = 10 + Math.random()*10;
  else if (seg.s <= 0.6) score = 40 + Math.random()*10;
  else score = 80 + Math.random()*15;
  return Math.round(score);
}

function generateSegmentMetrics(){
  const N=segments.length;
  segments.forEach(seg=>{
    const level = levelWithConnectivity(seg.s, N);
    const nearWater = clamp((level - 1.0)/2.5, 0, 1);
    
    const ndwi = clamp(NDWI(clamp(0.10+0.28*nearWater+rnd(0.04),0.01,0.95), clamp(0.06+0.18*(1-nearWater)+rnd(0.04),0.01,0.95)), -1, 1);
    const ndvi = clamp(NDVI(clamp(0.20+0.55*0.5+0.12*(1-clamp((0.18-ndwi)/0.25,0,1))+rnd(0.05),0.01,0.98), clamp(0.14+0.22*0.5+0.18*clamp((0.18-ndwi)/0.25,0,1)+rnd(0.05),0.01,0.98)), -1, 1);

    const leakProb = Math.round(clamp(10+55*Math.sin((seg.s*3.14)+FLOW.tick/6)+25*clamp((2.2-level)/1.6,0,1)+20*Math.random(), 0, 100));
    const deficit = clamp(0.55*clamp((2.1-level)/1.7,0,1) + 0.45*clamp((0.18-ndwi)/0.28,0,1), 0, 1);
    
    seg.level=level; seg.ndwi=ndwi; seg.ndvi=ndvi; 
    seg.leakProb=leakProb; seg.deficit=deficit; 
    seg.cropLoss=Math.round(clamp(0.45*clamp((0.20-ndwi)/0.25,0,1) + 0.35*clamp((0.45-ndvi)/0.35,0,1) + 0.20*deficit, 0, 1)*100);
    seg.risk = riskScore(seg);
    
    const baseNeed = 50 + (1 - seg.s) * 50; 
    seg.waterNeed = baseNeed;
    seg.deficitPct = Math.round(deficit * 100);
    seg.givenPct = 100 - seg.deficitPct;
    seg.givenVal = baseNeed * (seg.givenPct / 100);
    seg.missingVal = baseNeed * (seg.deficitPct / 100);

    seg.tds = clamp(400 + seg.s * 300 + rnd(50), 300, 1000);
    seg.flowRate = clamp(150 - seg.s * 80 + rnd(10), 20, 200);
    seg.soilMoisture = clamp(40 - seg.deficitPct * 0.3 + rnd(5), 10, 60);
    seg.evap = clamp(5 + seg.s * 2 + rnd(1), 2, 10);

    const reasons=[];
    if(seg.deficitPct >= 40) reasons.push("–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞–ª—ã“õ —Ç–∞–ø—à—ã–ª—ã“õ");
    else if(seg.deficitPct >= 15) reasons.push("–°—É –º”©–ª—à–µ—Ä—ñ –∞–∑");
    else reasons.push("“ö–∞–ª—ã–ø—Ç—ã");
    seg.reason = reasons.join(", ");
  });
}

// --------------------------------------------------
// OSM –ì–ï–û–ú–ï–¢–†–ò–Ø –§–£–ù–ö–¶–ò–Ø–õ–ê–†–´
// --------------------------------------------------
async function loadSyrDarya(){
  const drawFallback = () => {
      riverGroup.clearLayers();
      const fallbackRiver = [
        [43.7, 67.8], [43.91, 67.24], [44.18, 66.75], 
        [44.80, 65.50], [45.48, 64.05], [45.62, 63.31], [46.0, 61.5]
      ];
      const glowStyle = { pane:"riverPane", color:"#00e5ff", weight: 22, opacity: 0.18, lineCap:"round", lineJoin:"round" };
      const mainStyle = { pane:"riverPane", color:"#39ffcf", weight: 12, opacity: 0.80, lineCap:"round", lineJoin:"round" };
      L.polyline(fallbackRiver, glowStyle).addTo(riverGroup);
      L.polyline(fallbackRiver, mainStyle).addTo(riverGroup);
  };

  const s = 43.50, w = 62.00, n = 46.50, e = 68.00;
  const query = `[out:json][timeout:25];
    (
      way["waterway"="river"]["name"~"–°—ã—Ä–¥–∞—Ä—å—è|–°—ã—Ä–¥–∞—Ä–∏—è|Syr Darya|Sirdaryo"](${s},${w},${n},${e});
      way["waterway"="river"]["name:ru"~"–°—ã—Ä–¥–∞—Ä—å—è|–°—ã—Ä–¥–∞—Ä–∏—è"](${s},${w},${n},${e});
    );
    out body;
    >;
    out skel qt;`;
  
  const url = "https://overpass-api.de/api/interpreter";

  try {
      const res = await fetch(url, {
        method:"POST",
        headers: { "Content-Type":"text/plain;charset=UTF-8" },
        body: query
      });
      
      if (!res.ok) throw new Error("Overpass error: " + res.status);
      const osm = await res.json();

      const nodes = new Map();
      for (const el of osm.elements){
        if (el.type === "node") nodes.set(el.id, [el.lat, el.lon]);
      }

      const lines = [];
      for (const el of osm.elements){
        if (el.type !== "way" || !el.nodes) continue;
        const latlngs = el.nodes.map(id => nodes.get(id)).filter(Boolean);
        if (latlngs.length >= 2) lines.push(latlngs);
      }

      if (!lines.length){
        drawFallback();
        return;
      }

      riverGroup.clearLayers();

      const glowStyle = { pane:"riverPane", color:"#00e5ff", weight: 22, opacity: 0.18, lineCap:"round", lineJoin:"round" };
      const mainStyle = { pane:"riverPane", color:"#39ffcf", weight: 12, opacity: 0.80, lineCap:"round", lineJoin:"round" };

      for (const latlngs of lines){
        L.polyline(latlngs, glowStyle).addTo(riverGroup);
        L.polyline(latlngs, mainStyle).addTo(riverGroup);
      }

  } catch(err) {
      console.error("OSM Load Error:", err);
      drawFallback(); 
  }
}

function loadDistricts(){
    segments = [];
    let indexCount = 0;

    cityMarkers.forEach(city => {
        const layer = L.circle([city.lat, city.lng], {
            radius: 25000, 
            weight: 2,
            fillOpacity: 0.6,
            pane: "circlesPane" 
        });

        segments.push({
            id: city.name, 
            layer: layer, 
            centerPoint: [city.lat, city.lng],
            s: indexCount / Math.max(1, cityMarkers.length - 1),
            level:0, ndwi:0, ndvi:0, leakProb:0, deficit:0, cropLoss:0, risk:0, reason:"",
            waterNeed:0, givenPct:0, deficitPct:0, missingVal:0,
            tds:0, flowRate:0, soilMoisture:0, evap:0
        });
        indexCount++;
    });

    populateZoneSelect();
}

function populateZoneSelect() {
    const sel = document.getElementById("zoneSelect");
    sel.innerHTML = '<option value="" disabled selected data-i18n="pick_zone">–ê—É–¥–∞–Ω —Ç–∞“£–¥–∞—É</option>';
    segments.forEach(s => {
        sel.innerHTML += `<option value="${s.id}">${s.id}</option>`;
    });
}

function updateBriefText(id) {
    const briefObj = {
        "–ñ–∞“£–∞“õ–æ—Ä“ì–∞–Ω": "üìç –û“£—Ç“Ø—Å—Ç—ñ–∫ —à–µ–∫–∞—Ä–∞. –ê—É—ã–ª —à–∞—Ä—É–∞—à—ã–ª—ã“ì—ã “õ–∞—Ä“õ—ã–Ω–¥—ã, —Å—É –µ“£ –±—ñ—Ä—ñ–Ω—à—ñ –æ—Å—ã–Ω–¥–∞ –∫–µ–ª–µ–¥—ñ.",
        "–®–∏–µ–ª—ñ": "üçö –ö“Ø—Ä—ñ—à –∞–ª“õ–∞–ø—Ç–∞—Ä—ã –∫”©–ø –æ—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω –∞—É–¥–∞–Ω. –°—É–¥—ã ”©—Ç–µ –∫”©–ø “õ–∞–∂–µ—Ç –µ—Ç–µ–¥—ñ.",
        "“ö—ã–∑—ã–ª–æ—Ä–¥–∞ (–°—ã—Ä–¥–∞—Ä–∏—è)": "üèôÔ∏è –û–±–ª—ã—Å –æ—Ä—Ç–∞–ª—ã“ì—ã. –ò–Ω–¥—É—Å—Ç—Ä–∏—è –∂”ô–Ω–µ —Ö–∞–ª—ã“õ—Ç—ã“£ —Å—É–¥—ã —Ç“±—Ç—ã–Ω—É –¥–µ“£–≥–µ–π—ñ –∂–æ“ì–∞—Ä—ã.",
        "“ö–∞—Ä–º–∞“õ—à—ã": "‚ö†Ô∏è –¢”©–º–µ–Ω–≥—ñ –∞“ì—ã—Å“õ–∞ ”©—Ç—É –∞–π–º–∞“ì—ã. –°—É –¥–µ“£–≥–µ–π—ñ –º–µ–Ω —Å–∞–ø–∞—Å—ã —Ç”©–º–µ–Ω–¥–µ–π –±–∞—Å—Ç–∞–π–¥—ã.",
        "“ö–∞–∑–∞–ª—ã": "üåä –ê—Ä–∞–ª —Ç–µ“£—ñ–∑—ñ–Ω–µ –∂–∞“õ—ã–Ω —ç–∫–æ–ª–æ–≥–∏—è–ª—ã“õ —Ç—Ä–∞–Ω–∑–∏—Ç. –ú“±–Ω–¥–∞ —Å—É –µ“£ –∞–∑ –∂–µ—Ç–µ–¥—ñ."
    };
    const briefText = document.getElementById("zoneBriefText");
    briefText.style.display = "block";
    briefText.textContent = "‚ÑπÔ∏è " + (briefObj[id] || "–ê—É–¥–∞–Ω —Ç—É—Ä–∞–ª—ã “õ—ã—Å“õ–∞—à–∞ –º”ô–ª—ñ–º–µ—Ç.");
}

function initCharts() {
  const ctxLine = document.getElementById("forecastChart");
  if(ctxLine) {
    forecastChart = new Chart(ctxLine, {
      type: "line",
      data: {
        labels: ["-6 –∫“Ø–Ω", "-5 –∫“Ø–Ω", "-4 –∫“Ø–Ω", "-3 –∫“Ø–Ω", "-2 –∫“Ø–Ω", "-1 –∫“Ø–Ω", "–ë“Ø–≥—ñ–Ω"],
        datasets: [
          { label: "NDWI", data: [0.1, 0.2, 0.15, 0.18, 0.12, 0.1, 0.08], borderColor: "#4db6ff", backgroundColor: "rgba(77,182,255,0.1)", fill: true, tension: 0.3 },
          { label: "NDVI", data: [0.4, 0.42, 0.38, 0.35, 0.3, 0.25, 0.2], borderColor: "#2ef0a3", backgroundColor: "rgba(46,240,163,0.1)", fill: true, tension: 0.3 }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  const ctxPie = document.getElementById("pieChart");
  if(ctxPie) {
    pieChart = new Chart(ctxPie, {
      type: "doughnut",
      data: {
        labels: [],
        datasets: [{
          data: [],
          backgroundColor: [],
          borderWidth: 1,
          borderColor: "#101a2f"
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', labels: { color: '#e7eefc', font: {size: 11} } }
        },
        cutout: '60%'
      }
    });
  }
}

function updateCharts() {
  if(pieChart && segments.length > 0) {
    pieChart.data.labels = segments.map(s => s.id);
    pieChart.data.datasets[0].data = segments.map(s => s.deficitPct); 
    pieChart.data.datasets[0].backgroundColor = segments.map(s => riskColor(s.risk)); 
    pieChart.update();
  }

  if(forecastChart && segments.length > 0) {
    const baseNDWI = segments.reduce((sum, s)=>sum+s.ndwi, 0)/segments.length;
    const baseNDVI = segments.reduce((sum, s)=>sum+s.ndvi, 0)/segments.length;
    const newDataNDWI = forecastChart.data.datasets[0].data;
    const newDataNDVI = forecastChart.data.datasets[1].data;
    
    newDataNDWI.shift(); newDataNDWI.push(baseNDWI);
    newDataNDVI.shift(); newDataNDVI.push(baseNDVI);
    
    forecastChart.update();
  }
}

function showToast(title, msg) {
  const container = document.getElementById("toastContainer");
  const div = document.createElement("div");
  div.className = "toast";
  div.innerHTML = `<b style="color:var(--danger)">${title}</b><div style="font-size:12px;margin-top:4px;color:var(--muted)">${msg}</div>`;
  container.appendChild(div);
  
  let countSpan = document.getElementById("notifCount");
  countSpan.innerText = parseInt(countSpan.innerText) + 1;

  setTimeout(() => { div.remove(); }, 6000); 
}

function triggerAlerts() {
  const badZones = segments.filter(s => s.deficitPct > 55 || s.leakProb > 80);
  if(badZones.length > 0 && Math.random() > 0.4) { 
      const worst = badZones.sort((a,b) => b.deficitPct - a.deficitPct)[0];
      showToast("üö® –î–∞–±—ã–ª: " + worst.id, `–ö—Ä–∏—Ç–∏–∫–∞–ª—ã“õ —Å—É —Ç–∞–ø—à—ã–ª—ã“ì—ã (${worst.deficitPct}%) –Ω–µ–º–µ—Å–µ –∞–ø–∞—Ç—Ç—ã –∞–π–º–∞“õ —Ç—ñ—Ä–∫–µ–ª–¥—ñ!`);
  }
}

function openPremium() {
  document.getElementById("premiumModal").style.display = "flex";
}
function closePremium() {
  document.getElementById("premiumModal").style.display = "none";
}

function initMap(){
  map = L.map('map').setView([44.80, 65.50], 7);
  
  // –ñ–ê“¢–ê –§–£–ù–ö–¶–ò–Ø: –ï–∫—ñ —Ç“Ø—Ä–ª—ñ –∫–∞—Ä—Ç–∞ “õ–∞–±–∞—Ç—Ç–∞—Ä—ã
  satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution:'Esri' });
  vecLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution:'¬© OpenStreetMap, CARTO' });
  
  satLayer.addTo(map); // ”ò–¥–µ–ø–∫—ñ –±–æ–π—ã–Ω—à–∞ –°–ø—É—Ç–Ω–∏–∫

  map.createPane("riverPane");
  map.getPane("riverPane").classList.add("riverPane");
  map.getPane("riverPane").style.zIndex = 390; 
  map.getPane("riverPane").style.pointerEvents = "none"; 

  map.createPane("circlesPane");
  map.getPane("circlesPane").classList.add("circlesPane");
  map.getPane("circlesPane").style.zIndex = 410; 

  riverGroup = L.layerGroup([], { pane:"riverPane" }).addTo(map);
  segLayer = L.layerGroup().addTo(map);
  agroLayer = L.layerGroup().addTo(map);
  leaksLayer = L.layerGroup().addTo(map);
  labelsLayer = L.layerGroup().addTo(map);

  cityMarkers.forEach(city => {
      L.marker([city.lat, city.lng], { icon: L.divIcon({ className: 'map-label-icon', html: `<div class="map-label-text">${city.name}</div>`, iconSize: [100, 20], iconAnchor: [50, 10] }) }).addTo(labelsLayer);
  });

  const legend = L.control({position:'bottomright'});
  legend.onAdd = function(){
    const div = L.DomUtil.create('div','legend');
    div.innerHTML += '<b style="display:block;margin-bottom:6px">–°—É –¢–∞–ø—à—ã–ª—ã“ì—ã (–ê–π–º–∞“õ—Ç–∞—Ä)</b>';
    div.innerHTML += '<i style="background:#2ef0a3"></i> –ñ–∞—Å—ã–ª (–ù–æ—Ä–º–∞)<br>';
    div.innerHTML += '<i style="background:#ffcc00"></i> –°–∞—Ä—ã (–û—Ä—Ç–∞—à–∞ —Ç–∞–ø—à—ã–ª—ã“õ)<br>';
    div.innerHTML += '<i style="background:#ff4d6d"></i> “ö—ã–∑—ã–ª (“ö–∞—É—ñ–ø—Ç—ñ —Ç–∞–ø—à—ã–ª—ã“õ)<br>';
    return div;
  };
  legend.addTo(map);

  loadSyrDarya(); 
  loadDistricts();

  initCharts(); 
  bindUI(); refreshAll(); 
}

function bindUI(){
  document.getElementById("tglSegments").addEventListener("change",()=>{ document.getElementById("tglSegments").checked ? segLayer.addTo(map) : map.removeLayer(segLayer); });
  document.getElementById("tglRiver").addEventListener("change",()=>{ document.getElementById("tglRiver").checked ? riverGroup.addTo(map) : map.removeLayer(riverGroup); });
  document.getElementById("tglLeaks").addEventListener("change",()=>{ document.getElementById("tglLeaks").checked ? leaksLayer.addTo(map) : map.removeLayer(leaksLayer); });
  document.getElementById("segOpacity").addEventListener("input",()=>{ setSegOpacity(parseInt(document.getElementById("segOpacity").value,10)/100); });
  document.getElementById("tglAgro").addEventListener("change",()=> { applyAgroOverlay(); refreshRenderOnly(); });
  document.getElementById("agroModeToggle").addEventListener("change",()=>{ document.getElementById("tglAgro").checked = document.getElementById("agroModeToggle").checked; applyAgroOverlay(); refreshRenderOnly(); });
  document.getElementById("autoTick").addEventListener("change",()=>{ if(document.getElementById("autoTick").checked) autoTimer=setInterval(()=>refreshAll(),15000); else { clearInterval(autoTimer); autoTimer=null; } });
  
  // –ö–∞—Ä—Ç–∞ –∞—É—ã—Å—Ç—ã—Ä—É —Ñ—É–Ω–∫—Ü–∏—è—Å—ã–Ω —Ç—ã“£–¥–∞—É—à—ã (2GIS vs Sat)
  document.getElementById("baseMapSelect").addEventListener("change", (e) => {
    if(e.target.value === "sat") {
        map.removeLayer(vecLayer);
        satLayer.addTo(map);
    } else {
        map.removeLayer(satLayer);
        vecLayer.addTo(map);
    }
  });
}

function setSegOpacity(alpha){ segments.forEach(seg => { seg.layer.setStyle({fillOpacity: clamp(alpha,0,0.9)}); }); }

function renderRiverRisk(){
  segLayer.clearLayers();
  const alpha=parseInt(document.getElementById("segOpacity").value,10)/100;
  const agroOn = document.getElementById("agroModeToggle").checked || document.getElementById("tglAgro").checked;

  segments.forEach(seg=>{
    const c=riskColor(seg.risk);
    seg.layer.setStyle({ color:c, fillColor:c, fillOpacity: clamp(alpha,0,0.9) });
    seg.layer.addTo(segLayer);

    const cropLine = agroOn ? `<hr style="border:none;border-top:1px solid rgba(255,255,255,0.08);margin:8px 0">üçö –ö“Ø—Ä—ñ—à—Ç–µ–Ω –∫–µ–ª–µ—Ç—ñ–Ω —à—ã“ì—ã–Ω “õ–∞—É–ø—ñ: <b>${seg.cropLoss}%</b>` : "";
    let statusLabel = (c === "#ff4d6d") ? "“ö—ã–∑—ã–ª –ê–π–º–∞“õ (–°—É –¢–∞–ø—à—ã–ª—ã“ì—ã!)" : (c === "#ffcc00") ? "–°–∞—Ä—ã –ê–π–º–∞“õ (–û—Ä—Ç–∞—à–∞ —Ç–∞–ø—à—ã–ª—ã“õ)" : "–ñ–∞—Å—ã–ª –ê–π–º–∞“õ (–°—É –∂–µ—Ç–∫—ñ–ª—ñ–∫—Ç—ñ)";

    seg.layer.bindPopup(`
      <div style="min-width:240px;font-family:system-ui;color:#e7eefc;background:#101a2f;padding:10px;border-radius:8px;">
        <b style="color:${c};font-size:15px;">–ê—É–¥–∞–Ω: ${seg.id}</b>
        <div style="margin-top:6px;color:#fff;font-weight:bold;font-size:13px">${statusLabel}</div>
        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.08);margin:8px 0">
        üíß <b>–°—É –±–∞–ª–∞–Ω—Å—ã:</b><br>
        ‚Ä¢ “ö–∞–∂–µ—Ç—Ç—ñ–ª—ñ–∫: <b style="color:#4db6ff">${seg.waterNeed.toFixed(1)} –º–ª–Ω –º¬≥</b><br>
        ‚Ä¢ –ñ–µ—Ç–µ—Ç—ñ–Ω —Å—É: <b>${seg.givenPct}%</b> (${seg.givenVal.toFixed(1)} –º–ª–Ω –º¬≥)<br>
        ‚Ä¢ –¢–∞–ø—à—ã–ª—ã“õ (–∂–µ—Ç–ø–µ–π–¥—ñ): <b style="color:#ff4d6d">${seg.deficitPct}%</b><br>
        ‚Ä¢ –ñ–µ—Ç–∫—ñ–∑—É/“Æ–Ω–µ–º–¥–µ—É –∫–µ—Ä–µ–∫: <b style="color:#ffcc00">${seg.missingVal.toFixed(1)} –º–ª–Ω –º¬≥</b><br>
        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.08);margin:8px 0">
        üí• <b>–£—Ç–µ—á–∫–∞ “õ–∞—É–ø—ñ (Leak): ${seg.leakProb}%</b><br>
        ${cropLine}
      </div>
    `);

    seg.layer.off('click').on("click",()=>{
      selectedSeg=seg;
      const selectEl = document.getElementById("zoneSelect");
      selectEl.value = seg.id;
      selectEl.style.borderColor = c;
      selectEl.style.color = c;
      renderZoneDetails(seg);
      buildDSS();
      addEcoScore(5);
    });
  });
  if(!document.getElementById("tglSegments").checked) map.removeLayer(segLayer);
}

function applyAgroOverlay(){
  agroLayer.clearLayers();
  if(!(document.getElementById("agroModeToggle").checked || document.getElementById("tglAgro").checked)) return;
  segments.forEach(seg=>{
    if(seg.ndvi < 0.20) return;
    const col=(seg.cropLoss>=70)?"#ff4d6d":(seg.cropLoss>=45)?"#ff8f2a":(seg.cropLoss>=25)?"#ffcc00":"#2ef0a3";
    L.circle(seg.centerPoint, { radius: 28000, color:"rgba(0,0,0,0)", weight:0, fillColor:col, fillOpacity: 0.10+0.25*(seg.cropLoss/100), pane: "circlesPane" }).addTo(agroLayer);
  });
  agroLayer.addTo(map);
}

function renderLeaks(){
  leaksLayer.clearLayers();
  const cand=[...segments].filter(s=>s.leakProb>=70).sort((a,b)=>b.leakProb-a.leakProb).slice(0,6);
  for(let i=0;i<cand.length-1;i++){
    const a=cand[i], b=cand[i+1];
    const prob=Math.round((a.leakProb+b.leakProb)/2);
    const col=prob>=85?"#ff4d6d":prob>=70?"#ff8f2a":"#ffcc00";
    L.polyline([a.centerPoint, b.centerPoint],{ color:col, weight:4, opacity:0.9, dashArray:"10 14" }).addTo(leaksLayer)
      .bindPopup(`<b style="color:${col}">–ê–ø–∞—Ç—Ç—ã –∞–π–º–∞“õ (Leak corridor)</b><br>–´“õ—Ç–∏–º–∞–ª–¥—ã“õ: <b>${prob}%</b>`);
  }
  if(!document.getElementById("tglLeaks").checked) map.removeLayer(leaksLayer);
}

function renderRanking(){
  const tbody=document.getElementById("risk-table");
  tbody.innerHTML="";
  [...segments].sort((a,b)=>b.risk-a.risk).slice(0,10).forEach(s=>{
    const c=riskColor(s.risk);
    tbody.innerHTML += `<tr><td>${s.id}</td><td><span class="riskPill" style="border-color:${c};color:${c}">${s.risk}</span></td><td style="color:var(--muted)">${s.reason}</td></tr>`;
  });
}

function detectAnomalies(){
  const anom = [...segments].sort((a,b)=>a.s-b.s).slice(0,2).filter(s=>Math.abs(s.level-HIST.levelMean(s.s))/Math.max(0.01,HIST.levelMean(s.s)) > 0.30);
  window.__anomCount=anom.length;
}

function renderKPI(){
  if(segments.length === 0) return;
  document.getElementById("k_level").textContent=fmt(segments.reduce((s,x)=>s+x.level,0)/segments.length,2)+" m";
  document.getElementById("k_ndwi").textContent=fmt(segments.reduce((s,x)=>s+x.ndwi,0)/segments.length,2);
  document.getElementById("k_ndvi").textContent=fmt(segments.reduce((s,x)=>s+x.ndvi,0)/segments.length,2);
  document.getElementById("k_anom").innerHTML=`<span style="color:var(--warn)">${window.__anomCount||0}</span>`;
  document.getElementById("k_leaks").innerHTML=`<span style="color:var(--danger)">${segments.filter(s=>s.leakProb>=80).length}</span>`;
}

function renderZoneDetails(seg){
  const c=riskColor(seg.risk);
  
  const selectEl = document.getElementById("zoneSelect");
  selectEl.value = seg.id;
  selectEl.style.borderColor = c;
  selectEl.style.color = c;
  
  updateBriefText(seg.id);
  document.getElementById("zoneHint").style.display = "none";

  document.getElementById("zoneMetrics").style.display="grid";
  document.getElementById("zoneActions").style.display="flex";
  document.getElementById("zoneChartWrap").style.display="block";

  document.getElementById("zNeed").textContent=seg.waterNeed.toFixed(1)+" –º–ª–Ω –º¬≥";
  document.getElementById("zDef").textContent=seg.deficitPct+"%";
  document.getElementById("zMissing").textContent=seg.missingVal.toFixed(1)+" –º–ª–Ω –º¬≥";
  document.getElementById("zCropLoss").textContent=seg.cropLoss+"%";
  
  document.getElementById("zTDS").textContent = seg.tds.toFixed(0) + " mg/L";
  document.getElementById("zFlow").textContent = seg.flowRate.toFixed(1) + " m¬≥/s";
  document.getElementById("zSoil").textContent = seg.soilMoisture.toFixed(1) + " %";
  document.getElementById("zEvap").textContent = seg.evap.toFixed(1) + " –º–º/–∫“Ø–Ω";

  const labels=["-6","-5","-4","-3","-2","-1","0"];
  const ndwiSeries=labels.map((_,i)=> clamp(seg.ndwi + 0.05*Math.sin((FLOW.tick-i)/3) + rnd(0.03), -1, 1));
  const ndviSeries=labels.map((_,i)=> clamp(seg.ndvi + 0.04*Math.cos((FLOW.tick-i)/4) - 0.06*clamp((0.18-ndwiSeries[i])/0.28,0,1) + rnd(0.03), -1, 1));
  if(zoneMiniChart) zoneMiniChart.destroy();
  zoneMiniChart = new Chart(document.getElementById("zoneMiniChart"),{ type:"line", data:{labels, datasets:[{label:"NDWI", data:ndwiSeries},{label:"NDVI", data:ndviSeries}]}, options:{responsive:true} });
}

function buildDSS(){
  const box=document.getElementById("dssBox");
  box.innerHTML="";
  const top=[...segments].sort((a,b)=>b.risk-a.risk).slice(0,3);
  const actions=[];

  if((window.__anomCount||0)>0) actions.push({ title: "–ò–Ω—Å–ø–µ–∫—Ü–∏—è“ì–∞ —Ö–∞–±–∞—Ä–ª–∞—É: –∑–∞“£—Å—ã–∑ —Å—É –∞–ª—É", meta: "–¢—Ä–∏–≥–≥–µ—Ä: upstream –¥–µ“£–≥–µ–π—ñ –∞—É—ã—Ç“õ—ã–¥—ã." });
  top.forEach((s,idx)=>{
    if(s.risk>=55) actions.push({ title: `–®–ª—é–∑–¥—ñ —Ä–µ—Ç—Ç–µ—É (prio ${idx+1})`, meta: `${s.id} ‚Ä¢ ${s.missingVal.toFixed(1)} –º–ª–Ω –º¬≥ —Å—É –∂–µ—Ç–∫—ñ–∑—É –∫–µ—Ä–µ–∫.` });
    if((document.getElementById("agroModeToggle").checked || document.getElementById("tglAgro").checked) && s.cropLoss>=55) 
      actions.push({ title: "–§–µ—Ä–º–µ—Ä–ª–µ—Ä–≥–µ –µ—Å–∫–µ—Ä—Ç—É", meta: `${s.id} ‚Ä¢ üçö –ö“Ø—Ä—ñ—à —à—ã“ì—ã–Ω—ã ${s.cropLoss}%` });
  });

  (actions.length?actions:[{ title: "–¢“±—Ä–∞“õ—Ç—ã", meta: "–ö—Ä–∏—Ç–∏–∫–∞–ª—ã“õ ”ô—Ä–µ–∫–µ—Ç –∂–æ“õ." }]).slice(0,7).forEach(a=>{
    const div=document.createElement("div"); div.className="dssItem";
    div.innerHTML=`<b>‚úÖ ${escapeHtml(a.title)}</b><div class="meta">${escapeHtml(a.meta)}</div>`; box.appendChild(div);
  });
}

function renderBalanceTab(){
  const tbody = document.getElementById("balance-table-body");
  tbody.innerHTML = "";
  
  const sorted = [...segments].sort((a,b)=> b.missingVal - a.missingVal);
  sorted.forEach(seg => {
    const c = riskColor(seg.risk);
    const status = (c === "#ff4d6d") ? "–¢–∞–ø—à—ã–ª—ã“õ (“ö–∞—É—ñ–ø—Ç—ñ)" : (c === "#ffcc00") ? "–û—Ä—Ç–∞—à–∞ —Ç–∞–ø—à—ã–ª—ã“õ" : "“ö–∞–ª—ã–ø—Ç—ã (–ù–æ—Ä–º–∞)";
    
    tbody.innerHTML += `
      <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
        <td style="padding:12px; font-weight:bold;">${seg.id}</td>
        <td style="padding:12px;"><span class="riskPill" style="border-color:${c};color:${c}">${status}</span></td>
        <td style="padding:12px;">${seg.waterNeed.toFixed(1)}</td>
        <td style="padding:12px;">${seg.givenPct}%</td>
        <td style="padding:12px; color:${c}; font-weight:bold;">${seg.deficitPct}%</td>
        <td style="padding:12px; color:var(--warn); font-weight:bold;">+ ${seg.missingVal.toFixed(1)}</td>
      </tr>
    `;
  });
}

function addChat(text,who){
  const box=document.getElementById("chatBox");
  const div=document.createElement("div"); div.className="msg "+(who==="user"?"user":"bot"); div.textContent=text;
  box.appendChild(div); box.scrollTop=box.scrollHeight;
}

function offlineAnswer(q){
  const text = q.toLowerCase();
  
  if(text.includes("—Å”ô–ª–µ–º") || text.includes("–ø—Ä–∏–≤–µ—Ç")) return "–°”ô–ª–µ–º! –ú–µ–Ω WaterAI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—ñ–º—ñ–Ω. –°—ã—Ä–¥–∞—Ä–∏—è —Å—É –±–∞–ª–∞–Ω—Å—ã, –∞—É–¥–∞–Ω–¥–∞—Ä –Ω–µ–º–µ—Å–µ –∏–Ω–¥–µ–∫—Å—Ç–µ—Ä —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞–π –±–µ—Ä—ñ“£—ñ–∑.";
  if(text.includes("–∫“Ø—Ä—ñ—à") || text.includes("—Ä–∏—Å")) return "“ö—ã–∑—ã–ª–æ—Ä–¥–∞ –æ–±–ª—ã—Å—ã–Ω–¥–∞ —Å—É–¥—ã“£ 80%-–¥–∞–Ω –∞—Å—Ç–∞–º—ã –∫“Ø—Ä—ñ—à ”©—Å—ñ—Ä—É–≥–µ –∫–µ—Ç–µ–¥—ñ. NDWI –∂”ô–Ω–µ —Ç–æ–ø—ã—Ä–∞“õ —ã–ª“ì–∞–ª–¥—ã–ª—ã“ì—ã –∞—Ä“õ—ã–ª—ã –æ–Ω—ã –æ“£—Ç–∞–π–ª–∞–Ω–¥—ã—Ä—É “õ–∞–∂–µ—Ç. –ê–≥—Ä–æ –ò–ò —Ä–µ–∂–∏–º—ñ–Ω “õ–æ—Å—ã–ø –∫”©—Ä—ñ“£—ñ–∑.";
  if(text.includes("ndwi")) return "NDWI (Normalized Difference Water Index) - —Å—É –±–µ—Ç—ñ–Ω—ñ“£ –∞—É–¥–∞–Ω—ã–Ω –∂”ô–Ω–µ —ã–ª“ì–∞–ª–¥—ã–ª—ã“õ—Ç—ã —Å–ø—É—Ç–Ω–∏–∫—Ç–µ–Ω –±–∞“õ—ã–ª–∞—É“ì–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω –∏–Ω–¥–µ–∫—Å. –û–ª 0-–¥–µ–Ω —Ç”©–º–µ–Ω –±–æ–ª—Å–∞, —Å—É —Ç–∞–ø—à—ã –¥–µ–≥–µ–Ω —Å”©–∑.";
  if(text.includes("ndvi")) return "NDVI - ”©—Å—ñ–º–¥—ñ–∫—Ç–µ—Ä–¥—ñ“£ –∂–∞–π“õ–∞–ª—É –∏–Ω–¥–µ–∫—Å—ñ. –ö“Ø—Ä—ñ—à –∞–ª“õ–∞–ø—Ç–∞—Ä—ã–Ω—ã“£ –∂–∞“ì–¥–∞–π—ã–Ω –±–∞“õ—ã–ª–∞—É “Ø—à—ñ–Ω –º–∞“£—ã–∑–¥—ã.";
  if(text.includes("“õ–∞—É—ñ–ø") || text.includes("–ø—Ä–æ–±–ª–µ–º–∞") || text.includes("–∞–ø–∞—Ç")) return "–ï“£ “õ–∞—É—ñ–ø—Ç—ñ –∞—É–¥–∞–Ω–¥–∞—Ä (—Å—É –∂–µ—Ç–ø–µ–π –∂–∞—Ç“õ–∞–Ω):\n" + [...segments].sort((a,b)=>b.missingVal-a.missingVal).slice(0,3).map(s=>`‚Ä¢ ${s.id} (–¢–∞–ø—à—ã–ª—ã“õ: ${s.missingVal.toFixed(1)} –º–ª–Ω –º¬≥)`).join("\n");
  if(text.includes("tds") || text.includes("—Å–∞–ø–∞")) return "TDS (Total Dissolved Solids) - —Å—É–¥–∞“ì—ã –µ—Ä—ñ–≥–µ–Ω —Ç“±–∑–¥–∞—Ä –º–µ–Ω –º–∏–Ω–µ—Ä–∞–ª–¥–∞—Ä –∫”©–ª–µ–º—ñ. “ö–∞–∑–∞–ª—ã —Å–∏—è“õ—Ç—ã —Ç”©–º–µ–Ω–≥—ñ –∞“ì—ã—Å—Ç–∞ —Ç“±–∑–¥—ã–ª—ã“õ –∂–æ“ì–∞—Ä—ã –±–æ–ª–∞–¥—ã.";
  if(text.includes("—à–µ—à—ñ–º") || text.includes("–Ω–µ —ñ—Å—Ç–µ—É –∫–µ—Ä–µ–∫")) return "–û“£ –∂–∞“õ—Ç–∞“ì—ã DSS (Decision Support System) –ø–∞–Ω–µ–ª—ñ–Ω “õ–∞—Ä–∞“£—ã–∑. –°–æ–ª –∂–µ—Ä–¥–µ –∂“Ø–π–µ ”ô—Ä –∞—É–¥–∞–Ω “Ø—à—ñ–Ω —à–ª—é–∑–¥–µ—Ä–¥—ñ –∞—à—É –Ω–µ–º–µ—Å–µ —Ñ–µ—Ä–º–µ—Ä–ª–µ—Ä–≥–µ –µ—Å–∫–µ—Ä—Ç—É –∂—ñ–±–µ—Ä—É–¥—ñ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ “±—Å—ã–Ω–∞–¥—ã.";
  
  if(text.includes("–∂–∞“£–∞“õ–æ—Ä“ì–∞–Ω")) return "–ñ–∞“£–∞“õ–æ—Ä“ì–∞–Ω –∞—É–¥–∞–Ω—ã ‚Äì ”©–∑–µ–Ω–Ω—ñ“£ –∂–æ“ì–∞—Ä“ì—ã –∞“ì—ã—Å—ã–Ω–¥–∞ –æ—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω (“ö—ã–∑—ã–ª–æ—Ä–¥–∞ –æ–±–ª—ã—Å—ã –±–æ–π—ã–Ω—à–∞). –û–Ω–¥–∞ —Å—É –¥–µ“£–≥–µ–π—ñ —Å–∞–ª—ã—Å—Ç—ã—Ä–º–∞–ª—ã —Ç“Ø—Ä–¥–µ —Ç“±—Ä–∞“õ—Ç—ã.";
  if(text.includes("—à–∏–µ–ª—ñ")) return "–®–∏–µ–ª—ñ –∞—É–¥–∞–Ω—ã–Ω–¥–∞ –∫“Ø—Ä—ñ—à –∫”©–ø –µ–≥—ñ–ª–µ–¥—ñ, —Å–æ–Ω–¥—ã“õ—Ç–∞–Ω —Å—É–¥—ã“£ –∫”©–ø –±”©–ª—ñ–≥—ñ –æ—Å—ã–Ω–¥–∞ —Ç“±—Ç—ã–Ω—ã–ª–∞–¥—ã. –£—Ç–µ—á–∫–∞ (–∞“ì—É) “õ–∞—É–ø—ñ–Ω –±–∞“õ—ã–ª–∞—É –º–∞“£—ã–∑–¥—ã.";
  if(text.includes("“õ—ã–∑—ã–ª–æ—Ä–¥–∞")) return "“ö—ã–∑—ã–ª–æ—Ä–¥–∞ “õ–∞–ª–∞—Å—ã –º–µ–Ω –°—ã—Ä–¥–∞—Ä–∏—è –∞—É–¥–∞–Ω—ã–Ω–¥–∞ —Ö–∞–ª—ã“õ —Ç—ã“ì—ã–∑–¥—ã“ì—ã –º–µ–Ω ”©–Ω–µ—Ä–∫”ô—Å—ñ–ø—Ç–µ—Ä —Å—É–¥—ã –∫”©–ø “õ–∞–∂–µ—Ç –µ—Ç–µ–¥—ñ.";
  if(text.includes("“õ–∞—Ä–º–∞“õ—à—ã")) return "“ö–∞—Ä–º–∞“õ—à—ã –∞—É–¥–∞–Ω—ã–Ω–¥–∞ —Å—É –¥–µ“£–≥–µ–π—ñ —Ç”©–º–µ–Ω–¥–µ–π –±–∞—Å—Ç–∞–π–¥—ã, —Ç—Ä–∞–Ω–∑–∏—Ç—Ç—ñ–∫ –∂–æ“ì–∞–ª—Ç—É–ª–∞—Ä –∫”©–ø –±–æ–ª–∞–¥—ã.";
  if(text.includes("“õ–∞–∑–∞–ª—ã")) return "“ö–∞–∑–∞–ª—ã –∞—É–¥–∞–Ω—ã ‚Äì ”©–∑–µ–Ω–Ω—ñ“£ —Ç”©–º–µ–Ω–≥—ñ –∞“ì—ã—Å—ã. –ú“±–Ω–¥–∞ —Å—É –µ“£ –∞–∑ –∂–µ—Ç–µ–¥—ñ –∂”ô–Ω–µ —ç–∫–æ–ª–æ–≥–∏—è–ª—ã“õ “õ–∞—É—ñ–ø ”©—Ç–µ –∂–æ“ì–∞—Ä—ã.";
  if(text.includes("–∞—Ä–∞–ª")) return "–ê—Ä–∞–ª“ì–∞ –±–∞—Ä–∞—Ç—ã–Ω —Å—É –º”©–ª—à–µ—Ä—ñ –°—ã—Ä–¥–∞—Ä–∏—è–Ω—ã“£ —Ç”©–º–µ–Ω–≥—ñ –∞“ì—ã—Å—ã–Ω–∞ (“ö–∞–∑–∞–ª—ã–¥–∞–Ω –∫–µ–π—ñ–Ω) —Ç—ñ–∫–µ–ª–µ–π –±–∞–π–ª–∞–Ω—ã—Å—Ç—ã. –ñ–æ“ì–∞—Ä“ì—ã –∂–∞“õ—Ç–∞ —Å—É–¥—ã “Ø–Ω–µ–º–¥–µ—É –ê—Ä–∞–ª–¥—ã —Å–∞“õ—Ç–∞–ø “õ–∞–ª—É “Ø—à—ñ–Ω –∞—Å–∞ –º–∞“£—ã–∑–¥—ã.";
  
  if(text.includes("–±–æ–ª–∞—à–∞“õ") || text.includes("–ø—Ä–æ–≥–Ω–æ–∑") || text.includes("–±–æ–ª–∂–∞–º")) return "AI –±–æ–ª–∂–∞–º—ã –±–æ–π—ã–Ω—à–∞: –µ–≥–µ—Ä —Å—É–¥—ã –±–∞—Å“õ–∞—Ä—É –æ—Å—ã “õ–∞–ª–ø—ã “õ–∞–ª—Å–∞, –∫–µ–ª–µ—Å—ñ 5 –∂—ã–ª–¥–∞ –°—ã—Ä–¥–∞—Ä–∏—è–¥–∞“ì—ã —Å—É —Ç–∞–ø—à—ã–ª—ã“ì—ã 15%-“ì–∞ –∞—Ä—Ç—É—ã –º“Ø–º–∫—ñ–Ω. WaterAI –¥”ô–ª –æ—Å—ã–Ω—ã –±–æ–ª–¥—ã—Ä–º–∞—É “Ø—à—ñ–Ω —Ä–µ—Å—É—Ä—Å—Ç–∞—Ä–¥—ã —Å–∞–Ω–¥—ã“õ –±–∞—Å“õ–∞—Ä—É“ì–∞ –∫”©–º–µ–∫—Ç–µ—Å–µ–¥—ñ.";
  if(text.includes("–∞–≥—Ä–æ –∏–∏") || text.includes("agro ai")) return "–ê–≥—Ä–æ –ò–ò “õ–∞—É—ñ–ø—Å—ñ–∑–¥—ñ–∫ “Ø—à—ñ–Ω: –∂“Ø–π–µ —Å–ø—É—Ç–Ω–∏–∫—Ç–µ–Ω NDWI/NDVI –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ–Ω –∞–ª–∞–¥—ã, “õ–∞–π –µ–≥—ñ—Å—Ç—ñ–∫–∫–µ —Å—É –∂–µ—Ç–ø–µ–π –∂–∞—Ç“õ–∞–Ω—ã–Ω –∞–Ω—ã“õ—Ç–∞–π–¥—ã –∂”ô–Ω–µ —Å—É–¥—ã –¥”ô–ª —Å–æ–ª –∂–µ—Ä–≥–µ –±–∞“ì—ã—Ç—Ç–∞—É“ì–∞ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã –∫–æ–º–∞–Ω–¥–∞ (—à–ª—é–∑–¥–µ—Ä–≥–µ) –±–µ—Ä–µ–¥—ñ.";
  if(text.includes("–∂–æ–±–∞") || text.includes("–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è") || text.includes("—Å—Ç–∞—Ä—Ç–∞–ø")) return "–ë“±–ª Water-AI Space –∂–æ–±–∞—Å—ã–Ω—ã“£ MVP –Ω“±—Å“õ–∞—Å—ã. –û–ª “ö—ã–∑—ã–ª–æ—Ä–¥–∞ ”©“£—ñ—Ä—ñ–Ω–¥–µ–≥—ñ —Å—É —Ç–∞–ø—à—ã–ª—ã“ì—ã–Ω –∞–ª–¥—ã–Ω –∞–ª–∞ –µ—Å–∫–µ—Ä—Ç—ñ–ø, —Ü–∏—Ñ—Ä–ª—ã“õ —Å—É –±–∞–ª–∞–Ω—Å—ã–Ω –±–∞—Å“õ–∞—Ä—É“ì–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω.";

  return "–ö–µ—à—ñ—Ä—ñ“£—ñ–∑, —Å“±—Ä–∞“ì—ã“£—ã–∑–¥—ã –Ω–∞“õ—Ç—ã–ª–∞–π –∞–ª–∞—Å—ã–∑ –±–∞? –ö–∞—Ä—Ç–∞–¥–∞–Ω –∞—É–¥–∞–Ω–¥—ã –±–∞—Å—Å–∞“£—ã–∑ –Ω–µ–º–µ—Å–µ ¬´–°—É –ë–∞–ª–∞–Ω—Å—ã¬ª —Ç–∞–±-—ã–Ω –∞—à—Å–∞“£—ã–∑, –±–∞—Ä–ª—ã“õ –º”ô–ª—ñ–º–µ—Ç —à—ã“ì–∞–¥—ã. –°–æ–Ω–¥–∞–π-–∞“õ NDWI, –ö“Ø—Ä—ñ—à, –ê—Ä–∞–ª –Ω–µ–º–µ—Å–µ –Ω–∞“õ—Ç—ã –∞—É–¥–∞–Ω –∞—Ç—ã–Ω –∂–∞–∑—ã–ø –∫”©—Ä—ñ“£—ñ–∑.";
}

function sendMessage(){
  const input=document.getElementById("chatInput"); const txt=(input.value||"").trim(); if(!txt) return;
  addChat(txt,"user"); input.value=""; setTimeout(() => addChat(offlineAnswer(txt),"bot"), 400);
}

function aiExplainSelected(){ if(!selectedSeg) return alert("–ê–ª–¥—ã–º–µ–Ω –∞—É–¥–∞–Ω–¥—ã —Ç–∞“£–¥–∞."); addChat(`${selectedSeg.id} –∞—É–¥–∞–Ω—ã–Ω–¥–∞ “õ–∞–∂–µ—Ç—Ç—ñ–ª—ñ–∫—Ç—ñ“£ ${selectedSeg.deficitPct}% –∂–µ—Ç—ñ—Å–ø–µ–π–¥—ñ. –û–Ω—ã —à–µ—à—É “Ø—à—ñ–Ω “õ–æ—Å—ã–º—à–∞ ${selectedSeg.missingVal.toFixed(1)} –º–ª–Ω –º¬≥ —Å—É –∂—ñ–±–µ—Ä—É –∫–µ—Ä–µ–∫.`, "bot"); }
function aiPlanSelected(){ buildDSS(); addChat("–û“£ –∂–∞“õ—Ç–∞“ì—ã DSS-—Ç—ñ “õ–∞—Ä–∞“£—ã–∑: —Å—É –∂—ñ–±–µ—Ä—É –∂”ô–Ω–µ —à–ª—é–∑–¥—ñ –∞—à—É ”ô—Ä–µ–∫–µ—Ç—Ç–µ—Ä—ñ –¥–∞–π—ã–Ω.", "bot"); }
let ecoScore=0; function addEcoScore(x){ ecoScore+=x; document.getElementById("ecoScore").textContent=String(ecoScore); }

function downloadReport(){
  const payload={ timestamp:new Date().toISOString(), ecoScore, districts: segments.map(s=>({id:s.id, risk:s.risk, deficitPct:s.deficitPct, missingValMCM:s.missingVal.toFixed(1)})) };
  const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:"application/json"})); a.download="water_balance_report.json"; a.click();
}

function refreshRenderOnly(){
  renderRiverRisk(); applyAgroOverlay(); renderLeaks(); renderRanking(); detectAnomalies(); renderKPI(); buildDSS(); renderBalanceTab(); updateCharts();
}
function refreshAll(){
  FLOW.tick+=1; generateSegmentMetrics(); refreshRenderOnly(); triggerAlerts();
  if(selectedSeg){ const s=segments.find(x=>x.id===selectedSeg.id); if(s){ selectedSeg=s; renderZoneDetails(s); } }
}

function triggerUpstreamShock(){ FLOW.impulses.push({t0:FLOW.tick, magnitude:0.55}); addChat("‚ö° Upstream —Å–æ“õ“õ—ã –∂–∞—Å–∞–ª–¥—ã. –¢”©–º–µ–Ω–¥–µ –¥–µ“£–≥–µ–π ”©–∑–≥–µ—Ä–µ–¥—ñ.", "bot"); addEcoScore(10); refreshAll(); }

function switchTab(tab,btn){
  document.querySelectorAll('.grid-row').forEach(el=>el.style.display='none');
  document.getElementById('tab-'+tab).style.display='grid';
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  if(tab==='map') setTimeout(()=>map.invalidateSize(),120);
}

// –ñ–ê“¢–ê –§–£–ù–ö–¶–ò–Ø: –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ª–æ–≥–∏–∫–∞—Å—ã
function runCalculator() {
  const area = parseFloat(document.getElementById("calcArea").value);
  const norm = parseFloat(document.getElementById("calcNorm").value);
  
  if(isNaN(area) || isNaN(norm) || area <= 0 || norm <= 0) {
    alert("–ú”ô–Ω–¥–µ—Ä–¥—ñ –¥“±—Ä—ã—Å –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑!");
    return;
  }
  
  const totalM3 = area * norm;
  const totalMCM = (totalM3 / 1000000).toFixed(2);
  
  const res = document.getElementById("calcResult");
  res.style.display = "block";
  res.innerHTML = `“ö–∞–∂–µ—Ç—Ç—ñ –∂–∞–ª–ø—ã —Å—É –∫”©–ª–µ–º—ñ:<br>
    <span style="font-size:28px; color:var(--ok)">${totalMCM} –º–ª–Ω –º¬≥</span><br>
    <span style="font-size:13px; color:var(--muted)">(${totalM3.toLocaleString('ru-RU')} –º¬≥)</span>`;
}

window.onload=()=>{ setLang("kk"); initMap(); initCompare(); };
</script>
</body>
</html>